{% extends "core/base.html" %}
{% block content %}
<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Incident Report #{{ data.id }}</h2>
        <div class="btn-group">
            {% if can_edit %}
            <a href="{% url 'edit_incident_form' data.id %}" class="btn btn-sm btn-warning">
                <i class="fas fa-edit"></i> Edit
            </a>
            {% endif %}
            <button onclick="window.print()" class="btn btn-sm btn-primary">
                <i class="fas fa-print"></i> Print/PDF
            </button>
            <a href="{% url 'download_incident_pdf' data.id %}" class="btn btn-sm btn-success">
                <i class="fas fa-file-pdf"></i> Download
            </a>
        </div>
    </div>

    <style>
        @media print {
            nav, .no-print, .btn-group {
                display: none !important;
            }
            body {
                padding: 0;
                font-size: 11pt;
                background-color: white !important;
            }
            .print-only {
                display: block !important;
            }
            .card {
                border: none !important;
                box-shadow: none !important;
            }
        }

        .protected-content {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .text-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .contact-table {
            width: 100%;
            border-collapse: collapse;
        }

        .contact-table th, .contact-table td {
            border: 1px solid #dee2e6;
            padding: 8px;
            vertical-align: top;
            word-wrap: break-word;
        }

        .contact-table th {
            background-color: #f8f9fa;
            text-align: left;
        }

        .checkbox-cell {
            width: 40px;
            text-align: center;
        }

        .datetime-cell {
            width: 150px;
            min-width: 150px;
        }

        .comment-cell {
            white-space: pre-wrap;
        }

        .section-title {
            color: #4e73df;
            margin-top: 20px;
        }

        /* Fix for table cell text wrapping */
        .contact-table td {
            word-break: break-word;
        }

        /* Ensure text areas don't overflow */
        .text-content, .comment-cell {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 10; /* Limit to 10 lines */
            -webkit-box-orient: vertical;
        }
    </style>

    <div class="card no-print">
        <div class="card-body protected-content">
            <!-- Basic Information -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <h5 class="section-title"><i class="fas fa-info-circle"></i> Basic Information</h5>
                    <hr>
                    <p><strong>Date/Time:</strong> {{ data.incident_datetime|date:"Y-m-d H:i" }}</p>
                    <p><strong>Service User:</strong> {{ data.service_user }}</p>
                    <p><strong>Date of Birth:</strong> {{ data.dob|date:"Y-m-d" }}</p>
                </div>
                <div class="col-md-6">
                    <h5 class="section-title"><i class="fas fa-clipboard-check"></i> Details</h5>
                    <hr>
                    <p><strong>Location:</strong> {{ data.location }}</p>
                    <p><strong>Staff Involved:</strong> {{ data.staff_involved }}</p>
                    <p><strong>Reported by:</strong> {{ data.staff.get_full_name }}</p>
                    <p><strong>Care Home:</strong> {{ data.carehome|default:"N/A" }}</p>
                </div>
            </div>

            <!-- Incident Details -->
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="section-title"><i class="fas fa-file-alt"></i> Incident Details</h5>
                    <hr>
                    <div class="mb-3">
                        <h6>Prior to Incident:</h6>
                        <div class="text-content">
                            {{ data.prior_description|default:"N/A" }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6>Incident Description:</h6>
                        <div class="text-content">
                            {{ data.incident_description|default:"N/A" }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6>Service User Response:</h6>
                        <div class="text-content">
                            {{ data.user_response|default:"N/A" }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medical and Contact Details -->
            <div class="row">
                <div class="col-md-6">
                    <h5 class="section-title"><i class="fas fa-user-md"></i> Medical Details</h5>
                    <hr>
                    <div class="mb-3">
                        <h6>Injuries:</h6>
                        <div class="text-content">
                            {{ data.injuries_detail|default:"N/A" }}
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6>PRN Medication:</h6>
                        <div class="p-3 bg-light">
                            <p><strong>Administered:</strong> {{ data.prn_administered|yesno:"Yes,No" }}</p>
                            {% if data.prn_administered %}
                            <p><strong>By whom:</strong> {{ data.prn_by_whom|default:"Not specified" }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <h5 class="section-title"><i class="fas fa-home"></i> Property Details</h5>
                    <hr>
                    <div class="text-content">
                        {{ data.property_damage|default:"No property damage reported" }}
                    </div>
                </div>

                <div class="col-md-6">
                    <h5 class="section-title"><i class="fas fa-address-book"></i> Contacted Parties</h5>
                    <hr>
                    <table class="contact-table">
                        <thead>
                            <tr>
                                <th>Person</th>
                                <th class="checkbox-cell">Contacted</th>
                                <th class="datetime-cell">Date/Time</th>
                                <th class="comment-cell">Comments</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Manager</td>
                                <td class="checkbox-cell">{% if data.contacted_manager %}✓{% else %}□{% endif %}</td>
                                <td class="datetime-cell">{% if data.contacted_manager %}{{ data.manager_contact_date|date:"Y-m-d H:i"|default:"Not specified" }}{% endif %}</td>
                                <td class="comment-cell">{% if data.contacted_manager %}{{ data.manager_contact_comment|default:"No comments" }}{% endif %}</td>
                            </tr>
                            <tr>
                                <td>Police</td>
                                <td class="checkbox-cell">{% if data.contacted_police %}✓{% else %}□{% endif %}</td>
                                <td class="datetime-cell">{% if data.contacted_police %}{{ data.police_contact_date|date:"Y-m-d H:i"|default:"Not specified" }}{% endif %}</td>
                                <td class="comment-cell">{% if data.contacted_police %}{{ data.police_contact_comment|default:"No comments" }}{% endif %}</td>
                            </tr>
                            <tr>
                                <td>Paramedics</td>
                                <td class="checkbox-cell">{% if data.contacted_paramedics %}✓{% else %}□{% endif %}</td>
                                <td class="datetime-cell">{% if data.contacted_paramedics %}{{ data.paramedics_contact_date|date:"Y-m-d H:i"|default:"Not specified" }}{% endif %}</td>
                                <td class="comment-cell">{% if data.contacted_paramedics %}{{ data.paramedics_contact_comment|default:"No comments" }}{% endif %}</td>
                            </tr>
                            <tr>
                                <td>Other: {% if data.contacted_other %}{{ data.other_contact_name|default:"Not specified" }}{% endif %}</td>
                                <td class="checkbox-cell">{% if data.contacted_other %}✓{% else %}□{% endif %}</td>
                                <td class="datetime-cell">{% if data.contacted_other %}{{ data.other_contact_date|date:"Y-m-d H:i"|default:"Not specified" }}{% endif %}</td>
                                <td class="comment-cell">{% if data.contacted_other %}{{ data.other_contact_comment|default:"No comments" }}{% endif %}</td>
                            </tr>
                        </tbody>
                    </table>

                    {% if data.pdf_file %}
                    <h5 class="section-title mt-4"><i class="fas fa-file-pdf"></i> Attached PDF</h5>
                    <hr>
                    <a href="{{ data.pdf_file.url }}" class="btn btn-sm btn-info" target="_blank">
                        <i class="fas fa-download"></i> View Attached PDF
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="d-none print-only">
        <p style="text-align: center; color: red; font-weight: bold;">
            For the official PDF version, please use the "Download PDF" button.
        </p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Copy protection
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        alert('Copying content is not permitted');
    });

    document.addEventListener('selectstart', function(e) {
        e.preventDefault();
    });

    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && (e.key === 'c' || e.key === 'C' ||
                          e.key === 'x' || e.key === 'X' ||
                          e.key === 'a' || e.key === 'A')) {
            e.preventDefault();
            alert('Copying content is not permitted');
        }
    });

    // Watermark effect
    const contentDivs = document.querySelectorAll('.protected-content');
    contentDivs.forEach(div => {
        div.style.backgroundImage = 'url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'400\' opacity=\'0.05\'><text x=\'50\' y=\'50\' font-family=\'Arial\' font-size=\'20\' transform=\'rotate(-30)\'>CONFIDENTIAL</text></svg>")';
        div.style.backgroundRepeat = 'repeat';
    });
});
</script>
{% endblock %}