{% extends 'core/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Staff Mappings</h2>
        {% if not show_form %}
            <a href="?show_form=true" class="btn btn-primary">Create Mapping</a>
        {% endif %}
    </div>

    {% if show_form %}
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <strong>{% if editing %}Edit{% else %}New{% endif %} Mapping</strong>
        </div>
        <div class="card-body">
            <form method="post" action="">
                {% csrf_token %}
                {% if editing %}
                    <input type="hidden" name="mapping_id" value="{{ mapping_instance.id }}">
                {% endif %}

                <div class="form-group mb-3">
                    <label for="id_staff">Staff</label>
                    {{ form.staff }}
                </div>

                <div class="form-group mb-3">
                    <label for="id_carehomes">Care Homes</label>
                    {{ form.carehomes }}
                </div>

                <div class="form-group mb-3">
                    <label for="id_service_users">Service Users</label>
                    <select name="service_users" id="id_service_users" class="form-control" multiple required>
                        {% if editing %}
                            {% for su in mapping_instance.service_users.all %}
                                <option value="{{ su.id }}" selected>
                                    {{ su.get_formatted_name }} ({{ su.carehome.name }})
                                </option>
                            {% endfor %}
                        {% else %}
                            <option value="">Select Care Home(s) first</option>
                        {% endif %}
                    </select>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-success">{% if editing %}Update{% else %}Save{% endif %}</button>
                    <a href="{% url 'staff-mapping' %}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {% if mappings %}
    <div class="card shadow-sm">
        <div class="card-header">
            <strong>Saved Mappings</strong>
        </div>
        <div class="card-body p-0">
            <table class="table table-bordered mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Staff Name</th>
                        <th>Mapped To</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
            {% for mapping in mappings %}
            <tr>
                <td>{{ mapping.id }}</td>
                <td>{{ mapping.staff.get_full_name }}</td>
                <td>
                    {% for carehome in mapping.carehomes.all %}
                        {{ carehome.name }}
                        ({% for su in mapping.service_users.all %}
                            {% if su.carehome == carehome %}
                                {{ su.get_formatted_name }}{% if not forloop.last %}, {% endif %}
                            {% endif %}
                        {% empty %}
                            No service users
                        {% endfor %})
                        {% if not forloop.last %}<br>{% endif %}
                    {% endfor %}
                </td>
                <td>{{ mapping.created_at|date:"d M Y" }}</td>
                <td>
                    <a href="?edit={{ mapping.id }}" class="btn btn-sm btn-primary">Edit</a>
                    <form method="post" action="{% url 'delete-mapping' mapping.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
            </table>
        </div>
    </div>
    {% else %}
        <div class="alert alert-info mt-4">No mapping found.</div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Initialize Select2
    $('#id_staff').select2({
        placeholder: "Select staff",
        allowClear: true,
        width: '100%'
    });

    $('#id_carehomes').select2({
        placeholder: "Select care home(s)",
        allowClear: true,
        width: '100%'
    });

    $('#id_service_users').select2({
        placeholder: "First select care home(s)",
        allowClear: true,
        width: '100%'
    });

    // Preselected service users (only when editing)
    var preselectedServiceUsers = [];
    {% if editing %}
        preselectedServiceUsers = [
            {% for su in mapping_instance.service_users.all %}
                "{{ su.id }}"{% if not forloop.last %}, {% endif %}
            {% endfor %}
        ];
    {% endif %}

    // Handle carehome selection change
    $('#id_carehomes').on('change', function() {
        const selectedCarehomes = $(this).val();
        const $serviceUsers = $('#id_service_users');

        $serviceUsers.empty().prop('disabled', true).trigger('change');

        if (selectedCarehomes && selectedCarehomes.length > 0) {
            $serviceUsers.select2({
                placeholder: "Loading service users...",
                allowClear: false,
                width: '100%'
            });

            const carehomeIds = selectedCarehomes.join(',');

            $.ajax({
                url: '{% url "get-service-users-by-carehome" %}',
                data: { 'carehome_id': carehomeIds },
                dataType: 'json',
                success: function(response) {
                    $serviceUsers.empty();
                    if (response.service_users && response.service_users.length) {
                        $.each(response.service_users, function(i, user) {
                            const option = $('<option>', {
                                value: user.id,
                                text: user.name + (user.carehome ? ' (' + user.carehome.name + ')' : '')
                            });

                            // Preselect already mapped users
                            if (preselectedServiceUsers.includes(user.id.toString())) {
                                option.attr('selected', 'selected');
                            }

                            $serviceUsers.append(option);
                        });
                        $serviceUsers.prop('disabled', false).trigger('change');
                    } else {
                        $serviceUsers.select2({
                            placeholder: "No service users found for selected care homes",
                            allowClear: false,
                            width: '100%'
                        });
                    }
                },
                error: function(xhr) {
                    console.error('Error:', xhr.responseJSON);
                    $serviceUsers.select2({
                        placeholder: "Error loading service users",
                        allowClear: false,
                        width: '100%'
                    });
                }
            });
        } else {
            $serviceUsers.select2({
                placeholder: "First select care home(s)",
                allowClear: true,
                width: '100%'
            }).prop('disabled', false);
        }
    });

    // If editing, trigger pre-population
    {% if editing %}
        // Staff preselect
        $('#id_staff').val("{{ mapping_instance.staff.id }}").trigger('change');

        // Carehomes preselect
        $('#id_carehomes').val([
            {% for ch in mapping_instance.carehomes.all %}
                "{{ ch.id }}"{% if not forloop.last %}, {% endif %}
            {% endfor %}
        ]).trigger('change');
    {% endif %}
});
</script>
{% endblock %}
